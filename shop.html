<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Merchant's Tongue - NLP Bargain Game</title>
    <style>
        :root {
            --bg: #121212;
            --panel: #1e1e1e;
            --accent: #d4af37; /* Gold */
            --player-bubble: #2c3e50;
            --ai-bubble: #27ae60;
            --text: #f0f0f0;
        }

        body {
            font-family: 'Palatino Linotype', 'Book Antiqua', Palatino, serif;
            background-color: var(--bg);
            color: var(--text);
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
        }

        #game-container {
            width: 600px;
            height: 80vh;
            background: var(--panel);
            display: flex;
            flex-direction: column;
            border-radius: 12px;
            border: 2px solid var(--accent);
            overflow: hidden;
            box-shadow: 0 0 20px rgba(212, 175, 55, 0.2);
        }

        .header {
            padding: 20px;
            background: #252525;
            text-align: center;
            border-bottom: 1px solid #444;
        }

        #chat-area {
            flex-grow: 1;
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 15px;
            background-image: linear-gradient(rgba(30,30,30,0.9), rgba(30,30,30,0.9)), 
                              url('https://www.transparenttextures.com/patterns/parchment.png');
        }

        .msg {
            max-width: 80%;
            padding: 12px 16px;
            border-radius: 15px;
            line-height: 1.5;
            position: relative;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .ai-msg { background: var(--ai-bubble); align-self: flex-start; border-bottom-left-radius: 2px; color: white; }
        .player-msg { background: var(--player-bubble); align-self: flex-end; border-bottom-right-radius: 2px; }

        .controls {
            padding: 20px;
            background: #252525;
            display: flex;
            gap: 10px;
        }

        input {
            flex-grow: 1;
            padding: 12px;
            border: 1px solid #444;
            background: #121212;
            color: white;
            border-radius: 8px;
            outline: none;
        }

        input:focus { border-color: var(--accent); }

        button {
            padding: 10px 25px;
            background: var(--accent);
            border: none;
            color: #000;
            font-weight: bold;
            border-radius: 8px;
            cursor: pointer;
        }

        .stats-bar {
            font-size: 0.85rem;
            color: #aaa;
            margin-top: 5px;
            display: flex;
            justify-content: space-around;
        }

        .highlight { color: var(--accent); font-weight: bold; }
    </style>
</head>
<body>

<div id="game-container">
    <div class="header">
        <h2 style="margin:0; color:var(--accent)">Master Trader Elara</h2>
        <div class="stats-bar">
            <span>Patience: <span id="patience">100</span>%</span>
            <span>Interest: <span id="respect">Neutral</span></span>
        </div>
    </div>

    <div id="chat-area">
        <div class="msg ai-msg">Greetings, traveler. This <span class="highlight">Emerald Amulet</span> is a rare find. I'm asking 500 gold for it. What say you?</div>
    </div>

    <div class="controls">
        <input type="text" id="player-input" placeholder="Type your offer or talk to her..." onkeypress="handleKey(event)">
        <button onclick="processInput()">Speak</button>
    </div>
</div>

<script>
    // --- GAME DATA ---
    const item = { name: "Emerald Amulet", startPrice: 500, floorPrice: 300 };
    let currentAsk = 500;
    let patience = 100;
    let respect = 50; // 0 to 100
    let gameOver = false;

    function handleKey(e) { if(e.key === "Enter") processInput(); }

    function processInput() {
        if(gameOver) return;
        const inputField = document.getElementById('player-input');
        const text = inputField.value.trim();
        if(!text) return;

        addMessage('player', text);
        inputField.value = "";

        // ANALYZE SENTENCE
        const detectedOffer = extractNumber(text);
        const sentiment = analyzeSentiment(text);

        setTimeout(() => {
            generateAIResponse(detectedOffer, sentiment);
        }, 600);
    }

    function extractNumber(str) {
        const match = str.match(/\d+/);
        return match ? parseInt(match[0]) : null;
    }

    function analyzeSentiment(str) {
        const s = str.toLowerCase();
        let score = 0;
        
        // Keywords that increase respect/patience
        if(s.includes("beautiful") || s.includes("quality") || s.includes("fair") || s.includes("please")) score += 20;
        // Keywords that decrease respect/patience
        if(s.includes("scam") || s.includes("expensive") || s.includes("rip off") || s.includes("bad")) score -= 25;
        // Logic words
        if(s.includes("other shop") || s.includes("cheaper")) score -= 10;

        return score;
    }

    function generateAIResponse(offer, sentiment) {
        let response = "";
        
        // 1. Update Internal State based on sentiment
        respect += sentiment;
        patience -= 10; // Base decay per turn

        // 2. Logic Branching
        if (offer === null) {
            if (sentiment > 0) response = "You have a kind tongue, but flattery doesn't pay my taxes. Give me a real number.";
            else if (sentiment < 0) response = "If you don't like my prices, the door is right there. Are you going to buy it or just complain?";
            else response = "I don't have all day for riddles. How much gold are you offering?";
        } 
        else if (offer >= currentAsk) {
            response = `Done! At ${offer} gold, I'd be a fool to say no. The amulet is yours.`;
            endGame(true);
        }
        else if (offer < item.floorPrice) {
            patience -= 20;
            response = offer < 100 ? "Are you mocking me? That's an insult!" : "That's far below my cost. I'd rather keep it.";
        }
        else {
            // Intelligent counter-offering
            // If they are polite (high respect), AI drops price faster
            let discountFactor = respect > 60 ? 0.5 : 0.3;
            let gap = currentAsk - offer;
            currentAsk -= Math.floor(gap * discountFactor);
            
            if (sentiment > 0) response = `I like your attitude. I'll meet you part way... ${currentAsk} gold?`;
            else response = `You're tight-fisted, aren't you? I can do ${currentAsk}, not a copper less.`;
        }

        // Check for Game Over
        if (patience <= 0) {
            response = "I've had enough of this. Get out of my sight!";
            endGame(false);
        }

        updateUI();
        addMessage('ai', response);
    }

    function addMessage(type, text) {
        const area = document.getElementById('chat-area');
        const div = document.createElement('div');
        div.className = `msg ${type}-msg`;
        div.innerText = text;
        area.appendChild(div);
        area.scrollTop = area.scrollHeight;
    }

    function updateUI() {
        document.getElementById('patience').innerText = Math.max(0, patience);
        let mood = "Neutral";
        if (respect > 70) mood = "Friendly";
        if (respect < 30) mood = "Annoyed";
        document.getElementById('respect').innerText = mood;
    }

    function endGame(won) {
        gameOver = true;
        setTimeout(() => {
            alert(won ? "Success! You secured the item." : "Failed! You were kicked out.");
            location.reload();
        }, 1000);
    }
</script>

</body>
</html>

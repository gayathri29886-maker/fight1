<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>History Match: Event & Date</title>
    <!-- Load Tailwind CSS via CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom styles for matching items */
        .game-item {
            cursor: pointer;
            transition: all 0.2s ease;
            user-select: none;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            font-family: 'Inter', sans-serif;
            text-align: center;
        }

        /* Dark Mode: Adjust base item styles for better contrast */
        .dark .game-item {
            background-color: #374151; /* Gray-700 equivalent */
            border-color: #4b5563; /* Gray-600 equivalent */
            color: #d1d5db; /* Gray-300 equivalent */
        }

        /* Selection state */
        .game-item.selected {
            transform: scale(1.05);
            background-color: #fca5a5; /* Red-300 (Light Mode) */
            border-color: #ef4444; /* Red-500 */
            box-shadow: 0 10px 15px -3px rgb(239 68 68 / 0.5), 0 4px 6px -4px rgb(239 68 68 / 0.5);
            color: #7f1d1d; /* Text for contrast in light/dark */
        }

        .dark .game-item.selected {
            background-color: #f87171; /* Red-400 (Darker for dark mode) */
            color: #1f2937; /* Dark text for contrast */
        }

        /* Matched state (correct pair) */
        .game-item.matched {
            cursor: default;
            background-color: #6ee7b7; /* Emerald-300 */
            border-color: #10b981; /* Emerald-500 */
            color: #064e3b; /* Emerald-900 */
            box-shadow: none;
            pointer-events: none;
            opacity: 0.8;
            transform: scale(1.0);
        }

        /* Locked state (waiting for check) */
        .game-item.locked {
            pointer-events: none;
            opacity: 0.8;
        }

        /* General font setting */
        body {
            font-family: 'Inter', sans-serif;
        }

        /* Icon styling */
        .icon {
            width: 24px;
            height: 24px;
        }
    </style>
    <script>
        // Tailwind config to enable dark mode based on class
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                }
            }
        }
    </script>
</head>
<body class="bg-gray-100 dark:bg-gray-900 min-h-screen p-4 md:p-8 flex items-center justify-center transition-colors duration-500">

    <div id="gameContainer" class="w-full max-w-4xl bg-white dark:bg-gray-800 p-6 md:p-10 rounded-xl shadow-2xl transition-colors duration-500">

        <!-- Header and Theme Toggle -->
        <div class="flex justify-between items-start mb-4">
            <h1 class="text-3xl md:text-4xl font-extrabold text-gray-800 dark:text-gray-100 transition-colors duration-500">
                History Match Game
            </h1>
            <button id="themeToggle" onclick="toggleTheme()" class="p-3 rounded-full bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-yellow-400 shadow-md hover:shadow-lg transition">
                <!-- Moon Icon (for Light Mode) -->
                <svg id="moonIcon" class="icon hidden" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                    <path fill-rule="evenodd" d="M9.52 2.22a.75.75 0 0 1 .75-.626c.767.142 1.564.215 2.38.215 1.52 0 2.946.398 4.207 1.109A7.957 7.957 0 0 1 20 12c0 .825-.098 1.631-.29 2.404-.27.892-.375 1.83.21 2.378.585.548 1.545.474 2.436.204a.75.75 0 0 1 .632.746.75.75 0 0 1-.784.673c-.933.27-1.92.39-2.923.39-1.52 0-2.947-.398-4.207-1.109A7.957 7.957 0 0 1 4 12c0-.825.098-1.631.29-2.404.27-.892.375-1.83-.21-2.378-.585-.548-1.545-.474-2.436-.204a.75.75 0 0 1-.632-.746c.045-.407.35-.724.784-.673.933.27 1.92.39 2.923.39 1.52 0 2.947-.398 4.207-1.109A7.957 7.957 0 0 0 12 4c.825 0 1.631.098 2.404.29.892.27 1.83.375 2.378-.21.548-.585.474-1.545.204-2.436a.75.75 0 0 1 .746-.632.75.75 0 0 1 .673.784c-.27.933-.39 1.92-.39 2.923 0 1.52.398 2.947 1.109 4.207A7.957 7.957 0 0 0 12 20c-.825 0-1.631-.098-2.404-.29-.892-.27-1.83-.375-2.378.21-.548.585-.474 1.545-.204 2.436a.75.75 0 0 1-.746.632.75.75 0 0 1-.673-.784c.27-.933.39-1.92.39-2.923 0-1.52-.398-2.947-1.109-4.207A7.957 7.957 0 0 0 4 12c0-.825-.098-1.631-.29-2.404-.27-.892-.375-1.83.21-2.378.548-.585 1.545-.474 2.436-.204a.75.75 0 0 1 .746.632.75.75 0 0 1-.673.784z" clip-rule="evenodd" />
                </svg>

                <!-- Sun Icon (for Dark Mode) -->
                <svg id="sunIcon" class="icon hidden" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M12 2.25a.75.75 0 0 1 .75.75v2.25a.75.75 0 0 1-1.5 0V3a.75.75 0 0 1 .75-.75ZM7.675 6.275a.75.75 0 0 0 1.06 1.06l1.59-1.59a.75.75 0 0 0-1.06-1.06l-1.59 1.59ZM16.325 6.275l-1.59-1.59a.75.75 0 0 0-1.06 1.06l1.59 1.59a.75.75 0 0 0 1.06-1.06ZM2.25 12a.75.75 0 0 1 .75-.75h2.25a.75.75 0 0 1 0 1.5H3a.75.75 0 0 1-.75-.75ZM18.75 12a.75.75 0 0 1 .75-.75h2.25a.75.75 0 0 1 0 1.5H19.5a.75.75 0 0 1-.75-.75ZM7.675 17.725l-1.59 1.59a.75.75 0 0 0 1.06 1.06l1.59-1.59a.75.75 0 0 0-1.06-1.06ZM16.325 17.725a.75.75 0 0 0-1.06 1.06l1.59 1.59a.75.75 0 0 0 1.06-1.06l-1.59-1.59ZM12 18.75a.75.75 0 0 1 .75.75v2.25a.75.75 0 0 1-1.5 0v-2.25a.75.75 0 0 1 .75-.75ZM12 6a6 6 0 1 0 0 12 6 6 0 0 0 0-12Z" />
                </svg>
            </button>
        </div>

        <p class="text-center text-gray-600 dark:text-gray-400 mb-8 transition-colors duration-500">Match the historical event to the correct year.</p>

        <!-- Score and Message Area -->
        <div class="flex flex-col md:flex-row justify-between items-center mb-6 space-y-4 md:space-y-0 text-lg font-semibold">
            <div id="setInfo" class="text-indigo-600 dark:text-indigo-400">Set 1 of 3</div>
            <div id="scoreDisplay" class="text-blue-600 dark:text-blue-400">Total Score: 0</div>
        </div>
        <div id="messageDisplay" class="text-gray-700 dark:text-gray-300 h-6 text-center text-sm mb-6">Select an Event and a Year.</div>

        <!-- Game Grid -->
        <div id="gameGrid" class="grid grid-cols-2 gap-4 md:gap-6">
            <!-- Events Column (Left) -->
            <div id="eventColumn" class="space-y-4 bg-gray-50 dark:bg-gray-700 p-3 rounded-lg shadow-inner transition-colors duration-500">
                <h2 class="text-xl font-bold text-gray-700 dark:text-gray-200 text-center mb-2">Events</h2>
                <!-- Event items will be injected here -->
            </div>

            <!-- Years Column (Right) -->
            <div id="yearColumn" class="space-y-4 bg-gray-50 dark:bg-gray-700 p-3 rounded-lg shadow-inner transition-colors duration-500">
                <h2 class="text-xl font-bold text-gray-700 dark:text-gray-200 text-center mb-2">Years</h2>
                <!-- Year items will be injected here -->
            </div>
        </div>

        <!-- Control Buttons -->
        <div class="mt-8 flex justify-center space-x-4">
            <button id="nextSetButton" class="hidden px-6 py-3 bg-blue-500 text-white font-bold text-lg rounded-xl hover:bg-blue-600 transition duration-150 ease-in-out shadow-lg hover:shadow-xl focus:outline-none focus:ring-4 focus:ring-blue-300 dark:focus:ring-blue-700" onclick="loadNextSet()">
                Next Set &rarr;
            </button>
            <button id="resetButton" class="px-6 py-3 bg-red-500 text-white font-bold text-lg rounded-xl hover:bg-red-600 transition duration-150 ease-in-out shadow-lg hover:shadow-xl focus:outline-none focus:ring-4 focus:ring-red-300 dark:focus:ring-red-700" onclick="startGame()">
                Restart All
            </button>
        </div>

        <!-- Custom Alert Modal -->
        <div id="alertModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center">
            <div class="bg-white dark:bg-gray-700 p-8 rounded-xl shadow-2xl max-w-sm w-full text-center transition-colors duration-500">
                <h3 id="modalTitle" class="text-2xl font-bold text-gray-800 dark:text-gray-100 mb-4"></h3>
                <p id="modalMessage" class="text-gray-600 dark:text-gray-300 mb-6"></p>
                <button onclick="closeModal()" class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition">OK</button>
            </div>
        </div>
    </div>

    <script type="module">
        // --- Data ---
        const FACTS_PER_SET = 5;
        // Total of 15 facts, split into 3 sets of 5
        const HISTORY_FACTS = [
            // Set 1
            { id: 1, year: 1776, event: "US Declaration of Independence" },
            { id: 2, year: 1945, event: "End of World War II" },
            { id: 3, year: 1066, event: "Battle of Hastings" },
            { id: 4, year: 1969, event: "Apollo 11 Moon Landing" },
            { id: 5, year: 1492, event: "Columbus reaches the Americas" },
            // Set 2
            { id: 6, year: 1989, event: "Fall of the Berlin Wall" },
            { id: 7, year: 1815, event: "Battle of Waterloo" },
            { id: 8, year: 1914, event: "Start of World War I" },
            { id: 9, year: 1215, event: "Magna Carta signed" },
            { id: 10, year: 1517, event: "Start of the Protestant Reformation" },
            // Set 3
            { id: 11, year: 1929, event: "Start of the Great Depression" },
            { id: 12, year: 1959, event: "Invention of the Microchip" },
            { id: 13, year: 1991, event: "Dissolution of the Soviet Union" },
            { id: 14, year: 1903, event: "Wright Brothers' First Flight" },
            { id: 15, year: 1607, event: "Jamestown established (N. America)" },
        ];

        // --- State Variables ---
        let currentSetIndex = 0; // 0-based index for the current set
        let totalSets = Math.ceil(HISTORY_FACTS.length / FACTS_PER_SET);
        let setScore = 0; // Score for the current 5-fact set
        let totalGameScore = 0; // Cumulative score across all sets
        let currentGameFacts = []; // The 5 facts for the current set
        let selectedEventId = null;
        let selectedYearId = null;
        let isLocked = false;
        let matchedIds = new Set(); // IDs matched in the current set

        // --- DOM Elements ---
        const eventColumn = document.getElementById('eventColumn');
        const yearColumn = document.getElementById('yearColumn');
        const scoreDisplay = document.getElementById('scoreDisplay');
        const setInfo = document.getElementById('setInfo');
        const messageDisplay = document.getElementById('messageDisplay');
        const nextSetButton = document.getElementById('nextSetButton');
        const alertModal = document.getElementById('alertModal');
        const modalTitle = document.getElementById('modalTitle');
        const modalMessage = document.getElementById('modalMessage');
        const moonIcon = document.getElementById('moonIcon');
        const sunIcon = document.getElementById('sunIcon');

        // --- Utility Functions ---

        /** Simple Fisher-Yates shuffle algorithm. */
        function shuffleArray(array) {
            let currentIndex = array.length, randomIndex;
            while (currentIndex !== 0) {
                randomIndex = Math.floor(Math.random() * currentIndex);
                currentIndex--;
                [array[currentIndex], array[randomIndex]] = [array[randomIndex], array[currentIndex]];
            }
            return array;
        }

        /** Shows the custom modal/alert box. */
        function showModal(title, message) {
            modalTitle.textContent = title;
            modalMessage.textContent = message;
            alertModal.classList.remove('hidden');
        }

        /** Hides the custom modal/alert box. */
        window.closeModal = function() {
            alertModal.classList.add('hidden');
        }

        /** Updates the score and set progress display. */
        function updateGameDisplay() {
            scoreDisplay.textContent = `Total Score: ${totalGameScore} / ${HISTORY_FACTS.length}`;
            setInfo.textContent = `Set ${currentSetIndex + 1} of ${totalSets} (${setScore} / ${FACTS_PER_SET})`;
            nextSetButton.classList.add('hidden'); // Hide by default
        }

        /** Updates the main instruction/feedback message. */
        function updateMessage(message, colorClass = 'text-gray-700 dark:text-gray-300') {
            messageDisplay.className = colorClass + ' font-semibold h-6 text-center text-sm mb-6 transition-colors duration-300';
            messageDisplay.textContent = message;
        }

        // --- Theme Management Functions (same as before) ---

        function applyTheme(theme) {
            const html = document.documentElement;
            if (theme === 'dark') {
                html.classList.add('dark');
                moonIcon.classList.add('hidden');
                sunIcon.classList.remove('hidden');
            } else {
                html.classList.remove('dark');
                sunIcon.classList.add('hidden');
                moonIcon.classList.remove('hidden');
            }
            localStorage.setItem('theme', theme);
        }

        window.toggleTheme = function() {
            const currentTheme = localStorage.getItem('theme') || (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
            const newTheme = currentTheme === 'light' ? 'dark' : 'light';
            applyTheme(newTheme);
        }

        function loadTheme() {
            const storedTheme = localStorage.getItem('theme');

            if (storedTheme) {
                applyTheme(storedTheme);
            } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
                applyTheme('dark');
            } else {
                applyTheme('light');
            }
        }

        // --- Game Flow Functions ---

        /** Loads the facts for the current set index. */
        function loadCurrentSet() {
            const start = currentSetIndex * FACTS_PER_SET;
            const end = start + FACTS_PER_SET;
            
            // Slice the global facts list to get the current set
            currentGameFacts = HISTORY_FACTS.slice(start, end);

            // Reset set-specific state
            setScore = 0;
            matchedIds = new Set();
            selectedEventId = null;
            selectedYearId = null;
            
            updateGameDisplay();
            updateMessage("Select an Event and a Year.");
            renderGame();
        }

        /** Advances to the next set. */
        window.loadNextSet = function() {
            currentSetIndex++;
            if (currentSetIndex < totalSets) {
                loadCurrentSet();
            } else {
                // Should not happen if check is in checkMatch, but as a fallback
                endGame();
            }
        }

        /** Handles the logic when a set is fully completed. */
        function handleSetCompletion() {
            if (currentSetIndex < totalSets - 1) {
                updateMessage("Set Complete! Ready for the next challenge.", 'text-indigo-600 dark:text-indigo-400');
                nextSetButton.classList.remove('hidden');
            } else {
                endGame();
            }
        }

        /** Ends the game and displays the final score. */
        function endGame() {
            updateMessage("Game Over! All sets completed!", 'text-green-600 dark:text-emerald-300');
            nextSetButton.classList.add('hidden');
            showModal("Victory!", `You completed all sets with a total score of ${totalGameScore} out of ${HISTORY_FACTS.length}!`);
        }

        // --- Matching Logic ---

        function handleItemClick(e) {
            if (isLocked) return;

            const item = e.currentTarget;
            const itemId = parseInt(item.dataset.id);
            const itemType = item.dataset.type;

            if (matchedIds.has(itemId)) return;

            if (itemType === 'event') {
                handleSelection(item, itemId, selectedEventId, 'event', eventColumn);
                selectedEventId = selectedEventId === itemId ? null : itemId;
            } else if (itemType === 'year') {
                handleSelection(item, itemId, selectedYearId, 'year', yearColumn);
                selectedYearId = selectedYearId === itemId ? null : itemId;
            }

            if (selectedEventId !== null && selectedYearId !== null) {
                checkMatch();
            } else {
                updateMessage("Select one from each column.");
            }
        }

        function handleSelection(currentItem, currentId, previousId, itemType, parentColumn) {
            // Deselect previous item in the same column
            if (previousId !== null && previousId !== currentId) {
                const previousItem = parentColumn.querySelector(`[data-id="${previousId}"]`);
                if (previousItem) {
                    previousItem.classList.remove('selected');
                }
            }

            // Toggle selection for the current item
            if (currentId === previousId) {
                currentItem.classList.remove('selected');
            } else {
                currentItem.classList.add('selected');
            }
        }

        function checkMatch() {
            isLocked = true;
            updateMessage("Checking match...", 'text-yellow-600 dark:text-yellow-400');

            const isCorrect = selectedEventId === selectedYearId;

            const selectedEventElement = eventColumn.querySelector(`[data-id="${selectedEventId}"]`);
            const selectedYearElement = yearColumn.querySelector(`[data-id="${selectedYearId}"]`);

            const elementsToUpdate = [selectedEventElement, selectedYearElement].filter(Boolean);

            elementsToUpdate.forEach(el => el.classList.add('locked'));

            setTimeout(() => {
                elementsToUpdate.forEach(el => {
                    el.classList.remove('selected', 'locked');
                });

                if (isCorrect) {
                    setScore++;
                    totalGameScore++;
                    matchedIds.add(selectedEventId);

                    updateMessage("Correct Match!", 'text-green-600 dark:text-emerald-300');
                    updateGameDisplay();

                    // Apply matched style
                    elementsToUpdate.forEach(el => {
                        el.classList.add('matched');
                        el.classList.remove('bg-white', 'dark:bg-gray-700', 'bg-gray-50'); // Remove default background
                    });

                    // Check for set end
                    if (setScore === FACTS_PER_SET) {
                        handleSetCompletion();
                    }
                } else {
                    updateMessage("Incorrect. Try again.", 'text-red-600 dark:text-red-400');

                    // Apply temporary incorrect style (flashing red)
                    elementsToUpdate.forEach(el => {
                        el.classList.add('bg-red-400', 'border-red-600', 'dark:bg-red-600', 'dark:border-red-400');
                    });

                    setTimeout(() => {
                         // Remove temporary incorrect style
                        elementsToUpdate.forEach(el => {
                            el.classList.remove('bg-red-400', 'border-red-600', 'dark:bg-red-600', 'dark:border-red-400');
                        });
                    }, 500);
                }

                // Reset selections and unlock
                selectedEventId = null;
                selectedYearId = null;
                isLocked = false;
                if (setScore !== FACTS_PER_SET) {
                    setTimeout(() => {
                        updateMessage("Select an Event and a Year.");
                    }, 800);
                }
            }, 700);
        }

        // --- Rendering ---

        function renderGame() {
            eventColumn.innerHTML = '<h2 class="text-xl font-bold text-gray-700 dark:text-gray-200 text-center mb-2">Events</h2>';
            yearColumn.innerHTML = '<h2 class="text-xl font-bold text-gray-700 dark:text-gray-200 text-center mb-2">Years</h2>';

            const events = currentGameFacts.map(fact => ({ id: fact.id, text: fact.event }));
            const years = shuffleArray(currentGameFacts.map(fact => ({ id: fact.id, text: fact.year })));

            // Function to create a clickable item element
            const createItem = (id, text, type) => {
                const item = document.createElement('div');
                item.className = 'game-item p-3 rounded-lg border-2 border-gray-200 bg-white hover:bg-gray-50 dark:bg-gray-700 dark:border-gray-600 dark:text-gray-100 dark:hover:bg-gray-600 transition-colors duration-500';
                item.dataset.id = id;
                item.dataset.type = type;
                item.textContent = text;
                item.addEventListener('click', handleItemClick);

                // Check if already matched and apply the matched style
                if (matchedIds.has(id)) {
                    item.classList.add('matched');
                    item.classList.remove('bg-white', 'dark:bg-gray-700', 'hover:bg-gray-50', 'dark:hover:bg-gray-600');
                }

                return item;
            };

            // Inject elements
            events.forEach(item => eventColumn.appendChild(createItem(item.id, item.text, 'event')));
            years.forEach(item => yearColumn.appendChild(createItem(item.id, item.text, 'year')));
        }


        /** Initializes or restarts the entire game state. */
        window.startGame = function() {
            currentSetIndex = 0;
            totalGameScore = 0;
            loadCurrentSet();
            closeModal();
        }

        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            // 1. Load the user's theme preference
            loadTheme();
            // 2. Start the game (loads Set 1)
            startGame();
        });

    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>History Match: Event & Date</title>
    <!-- Load Tailwind CSS via CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom styles for matching items */
        .game-item {
            cursor: pointer;
            transition: all 0.2s ease;
            user-select: none;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            font-family: 'Inter', sans-serif;
            text-align: center;
        }

        /* Dark Mode: Adjust base item styles for better contrast */
        .dark .game-item {
            background-color: #374151; /* Gray-700 equivalent */
            border-color: #4b5563; /* Gray-600 equivalent */
            color: #d1d5db; /* Gray-300 equivalent */
        }

        /* Selection state */
        .game-item.selected {
            transform: scale(1.05);
            background-color: #fca5a5; /* Red-300 (Light Mode) */
            border-color: #ef4444; /* Red-500 */
            box-shadow: 0 10px 15px -3px rgb(239 68 68 / 0.5), 0 4px 6px -4px rgb(239 68 68 / 0.5);
            color: #7f1d1d; /* Text for contrast in light/dark */
        }

        .dark .game-item.selected {
            background-color: #f87171; /* Red-400 (Darker for dark mode) */
            color: #1f2937; /* Dark text for contrast */
        }

        /* Matched state (correct pair) */
        .game-item.matched {
            cursor: default;
            background-color: #6ee7b7; /* Emerald-300 */
            border-color: #10b981; /* Emerald-500 */
            color: #064e3b; /* Emerald-900 */
            box-shadow: none;
            pointer-events: none;
            opacity: 0.8;
            transform: scale(1.0);
        }

        /* Locked state (waiting for check) */
        .game-item.locked {
            pointer-events: none;
            opacity: 0.8;
        }

        /* General font setting */
        body {
            font-family: 'Inter', sans-serif;
        }

        /* Icon styling */
        .icon {
            width: 24px;
            height: 24px;
        }
    </style>
    <script>
        // Tailwind config to enable dark mode based on class
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                }
            }
        }
    </script>
</head>
<body class="bg-gray-100 dark:bg-gray-900 min-h-screen p-4 md:p-8 flex items-center justify-center transition-colors duration-500">

    <div id="gameContainer" class="w-full max-w-4xl bg-white dark:bg-gray-800 p-6 md:p-10 rounded-xl shadow-2xl transition-colors duration-500">

        <!-- Header and Theme Toggle -->
        <div class="flex justify-between items-start mb-4">
            <h1 class="text-3xl md:text-4xl font-extrabold text-gray-800 dark:text-gray-100 transition-colors duration-500">
                History Match Game
            </h1>
            <button id="themeToggle" onclick="toggleTheme()" class="p-3 rounded-full bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-yellow-400 shadow-md hover:shadow-lg transition">
                <!-- Moon Icon (for Light Mode) -->
                <svg id="moonIcon" class="icon hidden" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                    <path fill-rule="evenodd" d="M9.52 2.22a.75.75 0 0 1 .75-.626c.767.142 1.564.215 2.38.215 1.52 0 2.946.398 4.207 1.109A7.957 7.957 0 0 1 20 12c0 .825-.098 1.631-.29 2.404-.27.892-.375 1.83.21 2.378.585.548 1.545.474 2.436.204a.75.75 0 0 1 .632.746.75.75 0 0 1-.784.673c-.933.27-1.92.39-2.923.39-1.52 0-2.947-.398-4.207-1.109A7.957 7.957 0 0 1 4 12c0-.825.098-1.631.29-2.404.27-.892.375-1.83-.21-2.378-.585-.548-1.545-.474-2.436-.204a.75.75 0 0 1-.632-.746c.045-.407.35-.724.784-.673.933.27 1.92.39 2.923.39 1.52 0 2.947-.398 4.207-1.109A7.957 7.957 0 0 0 12 4c.825 0 1.631.098 2.404.29.892.27 1.83.375 2.378-.21.548-.585.474-1.545.204-2.436a.75.75 0 0 1 .746-.632.75.75 0 0 1 .673.784c-.27.933-.39 1.92-.39 2.923 0 1.52.398 2.947 1.109 4.207A7.957 7.957 0 0 0 12 20c-.825 0-1.631-.098-2.404-.29-.892-.27-1.83-.375-2.378.21-.548.585-.474 1.545-.204 2.436a.75.75 0 0 1-.746.632.75.75 0 0 1-.673-.784c.27-.933.39-1.92.39-2.923 0-1.52-.398-2.947-1.109-4.207A7.957 7.957 0 0 0 4 12c0-.825-.098-1.631-.29-2.404-.27-.892-.375-1.83.21-2.378.548-.585 1.545-.474 2.436-.204a.75.75 0 0 1 .746.632.75.75 0 0 1-.673.784z" clip-rule="evenodd" />
                </svg>

                <!-- Sun Icon (for Dark Mode) -->
                <svg id="sunIcon" class="icon hidden" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M12 2.25a.75.75 0 0 1 .75.75v2.25a.75.75 0 0 1-1.5 0V3a.75.75 0 0 1 .75-.75ZM7.675 6.275a.75.75 0 0 0 1.06 1.06l1.59-1.59a.75.75 0 0 0-1.06-1.06l-1.59 1.59ZM16.325 6.275l-1.59-1.59a.75.75 0 0 0-1.06 1.06l1.59 1.59a.75.75 0 0 0 1.06-1.06ZM2.25 12a.75.75 0 0 1 .75-.75h2.25a.75.75 0 0 1 0 1.5H3a.75.75 0 0 1-.75-.75ZM18.75 12a.75.75 0 0 1 .75-.75h2.25a.75.75 0 0 1 0 1.5H19.5a.75.75 0 0 1-.75-.75ZM7.675 17.725l-1.59 1.59a.75.75 0 0 0 1.06 1.06l1.59-1.59a.75.75 0 0 0-1.06-1.06ZM16.325 17.725a.75.75 0 0 0-1.06 1.06l1.59 1.59a.75.75 0 0 0 1.06-1.06l-1.59-1.59ZM12 18.75a.75.75 0 0 1 .75.75v2.25a.75.75 0 0 1-1.5 0v-2.25a.75.75 0 0 1 .75-.75ZM12 6a6 6 0 1 0 0 12 6 6 0 0 0 0-12Z" />
                </svg>
            </button>
        </div>

        <p class="text-center text-gray-600 dark:text-gray-400 mb-8 transition-colors duration-500">Match the historical event to the correct year.</p>

        <!-- Score and Message Area -->
        <div class="flex flex-col md:flex-row justify-between items-center mb-6 space-y-4 md:space-y-0 text-lg font-semibold">
            <div id="setInfo" class="text-indigo-600 dark:text-indigo-400">Set 1 of 3</div>
            <div id="scoreDisplay" class="text-blue-600 dark:text-blue-400">Total Score: 0</div>
        </div>
        <div id="messageDisplay" class="text-gray-700 dark:text-gray-300 h-6 text-center text-sm mb-6">Select an Event and a Year.</div>

        <!-- Game Grid -->
        <div id="gameGrid" class="grid grid-cols-2 gap-4 md:gap-6">
            <!-- Events Column (Left) -->
            <div id="eventColumn" class="space-y-4 bg-gray-50 dark:bg-gray-700 p-3 rounded-lg shadow-inner transition-colors duration-500">
                <h2 class="text-xl font-bold text-gray-700 dark:text-gray-200 text-center mb-2">Events</h2>
                <!-- Event items will be injected here -->
            </div>

            <!-- Years Column (Right) -->
            <div id="yearColumn" class="space-y-4 bg-gray-50 dark:bg-gray-700 p-3 rounded-lg shadow-inner transition-colors duration-500">
                <h2 class="text-xl font-bold text-gray-700 dark:text-gray-200 text-center mb-2">Years</h2>
                <!-- Year items will be injected here -->
            </div>
        </div>

        <!-- Control Buttons -->
        <div class="mt-8 flex justify-center space-x-4">
            <button id="nextSetButton" class="hidden px-6 py-3 bg-blue-500 text-white font-bold text-lg rounded-xl hover:bg-blue-600 transition duration-150 ease-in-out shadow-lg hover:shadow-xl focus:outline-none focus:ring-4 focus:ring-blue-300 dark:focus:ring-blue-700" onclick="loadNextSet()">
                Next Set &rarr;
            </button>
            <button id="resetButton" class="px-6 py-3 bg-red-500 text-white font-bold text-lg rounded-xl hover:bg-red-600 transition duration-150 ease-in-out shadow-lg hover:shadow-xl focus:outline-none focus:ring-4 focus:ring-red-300 dark:focus:ring-red-700" onclick="startGame()">
                Restart All
            </button>
        </div>

        <!-- Custom Alert Modal -->
        <div id="alertModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center">
            <div class="bg-white dark:bg-gray-700 p-8 rounded-xl shadow-2xl max-w-sm w-full text-center transition-colors duration-500">
                <h3 id="modalTitle" class="text-2xl font-bold text-gray-800 dark:text-gray-100 mb-4"></h3>
                <p id="modalMessage" class="text-gray-600 dark:text-gray-300 mb-6"></p>
                <button onclick="closeModal()" class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition">OK</button>
            </div>
        </div>
    </div>

    <script type="module">
        // --- Data ---
        const FACTS_PER_SET = 5;
        // Total of 15 facts, split into 3 sets of 5
        const HISTORY_FACTS = [
            { id: 1, year: 1776, event: "US Declaration of Independence" },
            { id: 2, year: 1945, event: "End of World War II" },
            { id: 3, year: 1066, event: "Battle of Hastings" },
            { id: 4, year: 1969, event: "Apollo 11 Moon Landing" },
            { id: 5, year: 1492, event: "Columbus reaches the Americas" },
            { id: 6, year: 1989, event: "Fall of the Berlin Wall" },
            { id: 7, year: 1815, event: "Battle of Waterloo" },
            { id: 8, year: 1914, event: "Start of World War I" },
            { id: 9, year: 1215, event: "Magna Carta signed" },
            { id: 10, year: 1517, event: "Start of the Protestant Reformation" },
            { id: 11, year: 1929, event: "Start of the Great Depression" },
            { id: 12, year: 1959, event: "Invention of the Microchip" },
            { id: 13, year: 1991, event: "Dissolution of the Soviet Union" },
            { id: 14, year: 1903, event: "Wright Brothers' First Flight" },
            { id: 15, year: 1607, event: "Jamestown established (N. America)" },
            { id: 16, text: "Which 'Silk Road' city, known for its library, was destroyed by Roman legions in 272 AD?", match: "Palmyrene Empire" },
            { id: 17, text: "The Byzantine Emperor Justinian I is best known for commissioning a comprehensive codification of Roman law, known as what?", match: "Byzantine Empire" },
            { id: 18, text: "The ancient kingdom of Aksum was a major trading power in the region of what modern-day country?", match: "Ethiopia" },
            { id: 19, text: "Boudica, the queen of the Iceni tribe, led a revolt against the occupying forces of which empire?", match: "Roman Britain" },
            { id: 20, text: "Which nomadic people, led by Attila, invaded the Roman Empire in the 5th century?", match: "Migration Period" },
            { id: 21, text: "The Magna Carta, signed in 1215, limited the power of which English king?", match: "Medieval England" },
            { id: 22, text: "The Great Schism of 1054 resulted in the split between the Roman Catholic Church and which other Christian church?", match: "Eastern Orthodoxy" },
            { id: 23, text: "Which Frankish king was crowned Emperor of the Romans on Christmas Day, 800 AD?", match: "Carolingian Empire" },
{id: 24, text: "The legendary Prester John was a mythical Christian king believed to rule a kingdom in which general region?", match: "Medieval Mythology" },
{id: 25, text: "The Mali Empire, one of the wealthiest in history, was founded by which legendary ruler?", match: "West Africa" },
{ id: 26, text: "The Khmer Empire built its capital at Angkor, in what present-day nation?", match: "Southeast Asia" },
{ id: 27, text: "The Battle of Tours in 732 halted the northward advance of which empire into Western Europe?", match: "Umayyad Caliphate" },
{ id: 28, text: "Which Viking explorer is credited with being the first European to reach North America?", match: "Norse Exploration" },
{ id: 29, text: "The Norman conquest of England was achieved following victory at which famous 1066 battle?", match: "Norman England" },
{ id: 30, text: "The Samurai were the military nobility of which feudal island nation?", match: "Medieval Japan" },
{ id: 31, text: "The Medici family were famous patrons of the arts in which Italian city during the Renaissance?", match: "Florence" },
{ id: 32, text: "The 95 Theses, which sparked the Protestant Reformation, were nailed to a church door by which German monk?", match: "Reformation" },
{ id: 33, text: "The Spanish conquistador Hernán Cortés is infamous for overthrowing which empire?", match: "Aztec Empire" },
{ id: 34, text: "The Mughal Empire was established in the Indian subcontinent by which ruler?", match: "Early Modern India" },
{ id: 35, text: "The St. Bartholomew's Day Massacre was a targeted group of assassinations in a conflict between Catholics and which other group in France?", match: "French Wars of Religion" },
{ id: 36, text: "Which powerful queen ruled England during the defeat of the Spanish Armada?", match: "Tudor England" },
{ id: 37, text: "The Ottoman Empire reached its peak under which sultan, known as 'the Magnificent'?", match: "Ottoman Empire" },
{ id: 38, text: "The Thirty Years' War was primarily fought in which region of Europe?", match: "Holy Roman Empire" },
{ id: 39, text: "The Ming Dynasty is famous for Admiral Zheng He's voyages and the construction of which major structure?", match: "Imperial China" },
{ id: 40, text: "The Inca Empire was centered in which mountain range?", match: "Andes Mountains" },
{ id: 41, text: "The Seven Years' War is known as the French and Indian War in the context of the colonies of which two nations?", match: "North America" },
{ id: 42, text: "The Storming of the Bastille on July 14, 1789, is a symbolic start to which revolution?", match: "French Revolution" },
{ id: 43, text: "Which military leader crowned himself Emperor of France in 1804?", match: "Napoleonic Wars" },
{ id: 44, text: "The Congress of Vienna (1814-15) aimed to redraw the map of Europe after the defeat of which leader?", match: "Concert of Europe" },
{ id: 45, text: "The 'Scramble for Africa' was the invasion and colonization of the continent by European powers during which historical period?", match: "New Imperialism" },
{ id: 46, text: "The unification of Germany in 1871 was orchestrated by which 'Iron Chancellor'?", match: "German Empire" },
{ id: 47, text: "The Meiji Restoration in 1868 ended the feudal rule of the shogunate in which country?", match: "Japan" },
{ id: 48, text: "The 'Manifest Destiny' was a belief that fueled the territorial expansion of which nation across North America?", match: "United States" },
{ id: 49, text: "The Boer Wars were fought between the British Empire and descendants of Dutch settlers in which modern country?", match: "South Africa" },
{ id: 50, text: "The Haitian Revolution (1791-1804) resulted in the establishment of the first independent republic in Latin America and was led by which former slave?", match: "Haiti" },
{ id: 51, text: "The assassination of Archduke Franz Ferdinand in 1914 was the immediate trigger for which global conflict?", match: "World War I" },
{ id: 52, text: "The Bolshevik Revolution of 1917 led to the creation of which new state?", match: "Soviet Union" },
{ id: 53, text: "The Great Depression began with the stock market crash on which date, known as Black Tuesday?", match: "United States" },
{ id: 54, text: "The policy of appeasement is most associated with British Prime Minister Neville Chamberlain's handling of which dictator?", match: "Interwar Period" },
{ id: 55, text: "D-Day, the largest seaborne invasion in history, was the Allied assault on the beaches of which French region?", match: "World War II" },
{ id: 56, text: "The Cold War was a period of geopolitical tension between the United States and which other superpower?", match: "Soviet Union" },
{ id: 57, text: "The 'Iron Curtain' was a term coined by Winston Churchill to describe the division between what two Europes?", match: "Cold War Europe" },
{ id: 58, text: "The Cuban Missile Crisis in 1962 brought the world to the brink of nuclear war between the US and which other nation?", match: "Soviet Union" },
{ id: 59, text: "The Vietnam War ended in 1975 with the fall of which city to North Vietnamese forces?", match: "Saigon" },
{ id: 60, text: "The policy of Glasnost, meaning 'openness', was introduced by which Soviet leader?", match: "Mikhail Gorbachev" },
{ id: 61, text: "Ferdinand Magellan's expedition was the first to achieve what circumnavigational feat?", match: "Age of Discovery" },
{ id: 62, text: "Which Venetian merchant's travels to China were recorded in 'The Travels of Marco Polo'?", match: "Medieval Exploration" },
{ id: 63, text: "The search for a Northwest Passage was driven by the desire to find a trade route to which region?", match: "Asia" },
{ id: 64, text: "Which British explorer mapped the coast of Australia and New Zealand on his ship the Endeavour?", match: "Captain James Cook" },
{ id: 65, text: "The source of the Nile River was discovered by which British explorers?", match: "Richard Burton and John Speke" },
{ id: 66, text: "Roald Amundsen was the first person to reach which geographic location?", match: "South Pole" },
{ id: 67, text: "The Lewis and Clark Expedition was commissioned by U.S. President Thomas Jefferson to explore which newly acquired territory?", match: "Louisiana Purchase" },
{ id: 68, text: "Which Norse explorer established the first settlement in Greenland?", match: "Eric the Red" },
{ id: 69, text: "The lost city of Machu Picchu was brought to international attention by which American historian in 1911?", match: "Hiram Bingham" },
{ id: 70, text: "The Silk Road was a network of trade routes connecting the East and West, linking which two great empires?", match: "Rome and China" },
{ id: 71, text: "The epic poems The Iliad and The Odyssey are attributed to which ancient Greek poet?", match: "Homer" },
{ id: 72, text: "The printing press with movable type was invented in Europe by which German craftsman?", match: "Johannes Gutenberg" },
{ id: 73, text: "The Sistine Chapel ceiling was painted by which Renaissance artist?", match: "Michelangelo" },
{ id: 74, text: "The theory of universal gravitation was proposed by which English scientist?", match: "Isaac Newton" },
{ id: 75, text: "The philosophical concept of the 'social contract' was developed by thinkers like John Locke and which French philosopher?", match: "Jean-Jacques Rousseau" },
{ id: 76, text: "The novel 'Don Quixote' is considered a founding work of modern Western literature and was written by which Spanish author?", match: "Miguel de Cervantes" },
{ id: 77, text: "The theory of evolution by natural selection was jointly proposed by Charles Darwin and which other naturalist?", match: "Alfred Russel Wallace" },
{ id: 78, text: "The artistic and intellectual movement that emphasized reason and individualism over tradition was known as what?", match: "The Enlightenment" },
{ id: 79, text: "The composition of the 'Messiah' oratorio is the work of which German-born composer?", match: "George Frideric Handel" },
{ id: 80, text: "The theory of relativity was developed by which famous physicist?", match: "Albert Einstein" },
{ id: 81, text: "The Punic Wars were a series of three wars fought between Rome and which North African city?", match: "Carthage" },
{ id: 82, text: "The Hundred Years' War was a long struggle between the kingdoms of England and which other European power?", match: "France" },
{ id: 83, text: "The American Civil War began with the Confederate attack on which Union fort?", match: "Fort Sumter" },
{ id: 84, text: "The Battle of Gettysburg was a major turning point in which war?", match: "American Civil War" },
{ id: 85, text: "The Crimean War (1853-1856) was fought between the Russian Empire and an alliance of the Ottoman Empire, France, Britain, and which other kingdom?", match: "Sardinia" },
{ id: 86, text: "The Russo-Japanese War (1904-1905) was the first major military victory in the modern era of an Asian power over a what?", match: "European power" },
{ id: 87, text: "The Gallipoli Campaign was a failed Allied attempt to capture the Ottoman capital of what?", match: "Constantinople" },
{ id: 88, text: "The Battle of Stalingrad during World War II was a major defeat for which army?", match: "German Wehrmacht" },
{ id: 89, text: "The Korean War began in 1950 when North Korean forces invaded which other nation on the peninsula?", match: "South Korea" },
{ id: 90, text: "The Gulf War in 1990-91 was triggered by Iraq's invasion and annexation of which neighboring country?", match: "Kuwait" },
{ id: 91, text: "The Black Death was a pandemic of plague that devastated which continent in the mid-14th century?", match: "Europe" },
{ id: 92, text: "The Industrial Revolution began in which European country in the late 18th century?", match: "Great Britain" },
{ id: 93, text: "The 'Trail of Tears' refers to the forced relocation of which Native American people?", match: "Cherokee" },
{ id: 94, text: "The construction of the Panama Canal was initially started by which European country?", match: "France" },
{ id: 95, text: "The 'Year of Africa' is the name given to 1960, when how many African countries gained independence?", match: "17" },
{ id: 96, text: "The fall of the Berlin Wall in 1989 symbolized the end of the division of which European city?", match: "Berlin" },
{ id: 97, text: "The ancient wonder known as the Hanging Gardens was said to have been located in which city?", match: "Babylon" },
{ id: 98, text: "The ancient Olympic Games were held in honor of which Greek god?", match: "Zeus" },
{ id: 99, text: "The Rosetta Stone was the key to deciphering Egyptian hieroglyphs because it contained the same text in three scripts: Greek, hieroglyphs, and what?", match: "Demotic" },
{ id: 100, text: "The ancient practice of sati, which was abolished by the British, was associated with which country?", match: "India" }
        ];

        // --- State Variables ---
        let currentSetIndex = 0; // 0-based index for the current set
        let totalSets = Math.ceil(HISTORY_FACTS.length / FACTS_PER_SET);
        let setScore = 0; // Score for the current 5-fact set
        let totalGameScore = 0; // Cumulative score across all sets
        let currentGameFacts = []; // The 5 facts for the current set
        let selectedEventId = null;
        let selectedYearId = null;
        let isLocked = false;
        let matchedIds = new Set(); // IDs matched in the current set

        // --- DOM Elements ---
        const eventColumn = document.getElementById('eventColumn');
        const yearColumn = document.getElementById('yearColumn');
        const scoreDisplay = document.getElementById('scoreDisplay');
        const setInfo = document.getElementById('setInfo');
        const messageDisplay = document.getElementById('messageDisplay');
        const nextSetButton = document.getElementById('nextSetButton');
        const alertModal = document.getElementById('alertModal');
        const modalTitle = document.getElementById('modalTitle');
        const modalMessage = document.getElementById('modalMessage');
        const moonIcon = document.getElementById('moonIcon');
        const sunIcon = document.getElementById('sunIcon');

        // --- Utility Functions ---

        /** Simple Fisher-Yates shuffle algorithm. */
        function shuffleArray(array) {
            let currentIndex = array.length, randomIndex;
            while (currentIndex !== 0) {
                randomIndex = Math.floor(Math.random() * currentIndex);
                currentIndex--;
                [array[currentIndex], array[randomIndex]] = [array[randomIndex], array[currentIndex]];
            }
            return array;
        }

        /** Shows the custom modal/alert box. */
        function showModal(title, message) {
            modalTitle.textContent = title;
            modalMessage.textContent = message;
            alertModal.classList.remove('hidden');
        }

        /** Hides the custom modal/alert box. */
        window.closeModal = function() {
            alertModal.classList.add('hidden');
        }

        /** Updates the score and set progress display. */
        function updateGameDisplay() {
            scoreDisplay.textContent = `Total Score: ${totalGameScore} / ${HISTORY_FACTS.length}`;
            setInfo.textContent = `Set ${currentSetIndex + 1} of ${totalSets} (${setScore} / ${FACTS_PER_SET})`;
            nextSetButton.classList.add('hidden'); // Hide by default
        }

        /** Updates the main instruction/feedback message. */
        function updateMessage(message, colorClass = 'text-gray-700 dark:text-gray-300') {
            messageDisplay.className = colorClass + ' font-semibold h-6 text-center text-sm mb-6 transition-colors duration-300';
            messageDisplay.textContent = message;
        }

        // --- Theme Management Functions (same as before) ---

        function applyTheme(theme) {
            const html = document.documentElement;
            if (theme === 'dark') {
                html.classList.add('dark');
                moonIcon.classList.add('hidden');
                sunIcon.classList.remove('hidden');
            } else {
                html.classList.remove('dark');
                sunIcon.classList.add('hidden');
                moonIcon.classList.remove('hidden');
            }
            localStorage.setItem('theme', theme);
        }

        window.toggleTheme = function() {
            const currentTheme = localStorage.getItem('theme') || (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
            const newTheme = currentTheme === 'light' ? 'dark' : 'light';
            applyTheme(newTheme);
        }

        function loadTheme() {
            const storedTheme = localStorage.getItem('theme');

            if (storedTheme) {
                applyTheme(storedTheme);
            } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
                applyTheme('dark');
            } else {
                applyTheme('light');
            }
        }

        // --- Game Flow Functions ---

        /** Loads the facts for the current set index. */
        function loadCurrentSet() {
            const start = currentSetIndex * FACTS_PER_SET;
            const end = start + FACTS_PER_SET;
            
            // Slice the global facts list to get the current set
            currentGameFacts = HISTORY_FACTS.slice(start, end);

            // Reset set-specific state
            setScore = 0;
            matchedIds = new Set();
            selectedEventId = null;
            selectedYearId = null;
            
            updateGameDisplay();
            updateMessage("Select an Event and a Year.");
            renderGame();
        }

        /** Advances to the next set. */
        window.loadNextSet = function() {
            currentSetIndex++;
            if (currentSetIndex < totalSets) {
                loadCurrentSet();
            } else {
                // Should not happen if check is in checkMatch, but as a fallback
                endGame();
            }
        }

        /** Handles the logic when a set is fully completed. */
        function handleSetCompletion() {
            if (currentSetIndex < totalSets - 1) {
                updateMessage("Set Complete! Ready for the next challenge.", 'text-indigo-600 dark:text-indigo-400');
                nextSetButton.classList.remove('hidden');
            } else {
                endGame();
            }
        }

        /** Ends the game and displays the final score. */
        function endGame() {
            updateMessage("Game Over! All sets completed!", 'text-green-600 dark:text-emerald-300');
            nextSetButton.classList.add('hidden');
            showModal("Victory!", `You completed all sets with a total score of ${totalGameScore} out of ${HISTORY_FACTS.length}!`);
        }

        // --- Matching Logic ---

        function handleItemClick(e) {
            if (isLocked) return;

            const item = e.currentTarget;
            const itemId = parseInt(item.dataset.id);
            const itemType = item.dataset.type;

            if (matchedIds.has(itemId)) return;

            if (itemType === 'event') {
                handleSelection(item, itemId, selectedEventId, 'event', eventColumn);
                selectedEventId = selectedEventId === itemId ? null : itemId;
            } else if (itemType === 'year') {
                handleSelection(item, itemId, selectedYearId, 'year', yearColumn);
                selectedYearId = selectedYearId === itemId ? null : itemId;
            }

            if (selectedEventId !== null && selectedYearId !== null) {
                checkMatch();
            } else {
                updateMessage("Select one from each column.");
            }
        }

        function handleSelection(currentItem, currentId, previousId, itemType, parentColumn) {
            // Deselect previous item in the same column
            if (previousId !== null && previousId !== currentId) {
                const previousItem = parentColumn.querySelector(`[data-id="${previousId}"]`);
                if (previousItem) {
                    previousItem.classList.remove('selected');
                }
            }

            // Toggle selection for the current item
            if (currentId === previousId) {
                currentItem.classList.remove('selected');
            } else {
                currentItem.classList.add('selected');
            }
        }

        function checkMatch() {
            isLocked = true;
            updateMessage("Checking match...", 'text-yellow-600 dark:text-yellow-400');

            const isCorrect = selectedEventId === selectedYearId;

            const selectedEventElement = eventColumn.querySelector(`[data-id="${selectedEventId}"]`);
            const selectedYearElement = yearColumn.querySelector(`[data-id="${selectedYearId}"]`);

            const elementsToUpdate = [selectedEventElement, selectedYearElement].filter(Boolean);

            elementsToUpdate.forEach(el => el.classList.add('locked'));

            setTimeout(() => {
                elementsToUpdate.forEach(el => {
                    el.classList.remove('selected', 'locked');
                });

                if (isCorrect) {
                    setScore++;
                    totalGameScore++;
                    matchedIds.add(selectedEventId);

                    updateMessage("Correct Match!", 'text-green-600 dark:text-emerald-300');
                    updateGameDisplay();

                    // Apply matched style
                    elementsToUpdate.forEach(el => {
                        el.classList.add('matched');
                        el.classList.remove('bg-white', 'dark:bg-gray-700', 'bg-gray-50'); // Remove default background
                    });

                    // Check for set end
                    if (setScore === FACTS_PER_SET) {
                        handleSetCompletion();
                    }
                } else {
                    updateMessage("Incorrect. Try again.", 'text-red-600 dark:text-red-400');

                    // Apply temporary incorrect style (flashing red)
                    elementsToUpdate.forEach(el => {
                        el.classList.add('bg-red-400', 'border-red-600', 'dark:bg-red-600', 'dark:border-red-400');
                    });

                    setTimeout(() => {
                         // Remove temporary incorrect style
                        elementsToUpdate.forEach(el => {
                            el.classList.remove('bg-red-400', 'border-red-600', 'dark:bg-red-600', 'dark:border-red-400');
                        });
                    }, 500);
                }

                // Reset selections and unlock
                selectedEventId = null;
                selectedYearId = null;
                isLocked = false;
                if (setScore !== FACTS_PER_SET) {
                    setTimeout(() => {
                        updateMessage("Select an Event and a Year.");
                    }, 800);
                }
            }, 700);
        }

        // --- Rendering ---

        function renderGame() {
            eventColumn.innerHTML = '<h2 class="text-xl font-bold text-gray-700 dark:text-gray-200 text-center mb-2">Events</h2>';
            yearColumn.innerHTML = '<h2 class="text-xl font-bold text-gray-700 dark:text-gray-200 text-center mb-2">Years</h2>';

            const events = currentGameFacts.map(fact => ({ id: fact.id, text: fact.event }));
            const years = shuffleArray(currentGameFacts.map(fact => ({ id: fact.id, text: fact.year })));

            // Function to create a clickable item element
            const createItem = (id, text, type) => {
                const item = document.createElement('div');
                item.className = 'game-item p-3 rounded-lg border-2 border-gray-200 bg-white hover:bg-gray-50 dark:bg-gray-700 dark:border-gray-600 dark:text-gray-100 dark:hover:bg-gray-600 transition-colors duration-500';
                item.dataset.id = id;
                item.dataset.type = type;
                item.textContent = text;
                item.addEventListener('click', handleItemClick);

                // Check if already matched and apply the matched style
                if (matchedIds.has(id)) {
                    item.classList.add('matched');
                    item.classList.remove('bg-white', 'dark:bg-gray-700', 'hover:bg-gray-50', 'dark:hover:bg-gray-600');
                }

                return item;
            };

            // Inject elements
            events.forEach(item => eventColumn.appendChild(createItem(item.id, item.text, 'event')));
            years.forEach(item => yearColumn.appendChild(createItem(item.id, item.text, 'year')));
        }


        /** Initializes or restarts the entire game state. */
        window.startGame = function() {
            currentSetIndex = 0;
            totalGameScore = 0;
            loadCurrentSet();
            closeModal();
        }

        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            // 1. Load the user's theme preference
            loadTheme();
            // 2. Start the game (loads Set 1)
            startGame();
        });

    </script>
</body>
</html>
